#!/bin/sh

# Recover unfinished installations by inspecting state files and
# re-running their installers with --resume.

STATE_DIR="/opt/upgrade/state"
PKG_DIR="/opt/upgrade/packages"
JOURNAL_DIR="/opt/upgrade/journal"

for st in "$STATE_DIR"/*.state; do
    [ -e "$st" ] || continue

    # Skip packages that have already finished
    step=$(grep '^STEP=' "$st" | cut -d= -f2)
    if [ "$step" = "DONE" ] || [ "$step" = "FAILED" ]; then
        continue
    fi

    ID=$(basename "$st" .state)
    ARCHIVE="$PKG_DIR/${ID}.tar.gz"
    [ -f "$ARCHIVE" ] || continue

    TMP="$(mktemp -d)"
    tar -xzf "$ARCHIVE" -C "$TMP"

    if [ -f "$TMP/package/scripts/install.sh" ]; then
        if (
            cd "$TMP/package" && ./scripts/install.sh --resume
        ); then
            rm -rf "$TMP"
        else
            echo "Installation failed for $ID; leaving $TMP for inspection" >&2
            exit 1
        fi
    else
        rm -rf "$TMP"
    fi
done

exit 0
