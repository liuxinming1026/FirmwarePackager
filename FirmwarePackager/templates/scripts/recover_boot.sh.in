#!/bin/sh

# Recover unfinished installations by inspecting state files and
# re-running their installers with --resume.

STATE_DIR="/opt/upgrade/state"
PKG_DIR="/opt/upgrade/packages"

for st in "$STATE_DIR"/*.state; do
    [ -e "$st" ] || continue
    status=$(grep '^STATUS=' "$st" | cut -d= -f2)
    if [ "$status" = "SUCCESS" ] || [ "$status" = "FAIL" ]; then
        continue
    fi
    ID=$(basename "$st" .state)
    ARCHIVE="$PKG_DIR/${ID}.tar.gz"
    [ -f "$ARCHIVE" ] || continue
    TMP="$(mktemp -d)"
    tar -xzf "$ARCHIVE" -C "$TMP"
    if [ -f "$TMP/package/scripts/install.sh" ]; then
        (
            cd "$TMP/package" && ./scripts/install.sh --resume
        )
    fi
    rm -rf "$TMP"
done

exit 0
