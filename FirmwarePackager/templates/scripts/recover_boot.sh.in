#!/bin/sh

# Recover unfinished installations by inspecting state files and
# re-running their installers with --resume.

STATE_DIR="/opt/upgrade/state"
PKG_DIR="/opt/upgrade/packages"

for st in "$STATE_DIR"/*.state; do
    [ -e "$st" ] || continue
    ID=$(basename "$st" .state)
    ARCHIVE="$PKG_DIR/${ID}.tar.gz"
    [ -f "$ARCHIVE" ] || continue
    TMP="$(mktemp -d)"
    tar -xzf "$ARCHIVE" -C "$TMP"
    if [ -f "$TMP/install.sh" ]; then
        (cd "$TMP" && ./install.sh --resume)
    fi
    rm -rf "$TMP"
done

exit 0
